# Database Setup for Assignment Planning

The assignment planning feature requires additional database tables that need to be created manually in your Supabase database.

## Step 1: Access Supabase SQL Editor

1. Go to your Supabase dashboard: https://supabase.com/dashboard
2. Select your project: `blzcjafcncgghwnmuxhl`
3. Navigate to the "SQL Editor" in the left sidebar
4. Create a new query

## Step 2: Run the Following SQL

Copy and paste this SQL script into the SQL Editor and click "Run":

```sql
-- Create missing tables for assignment planning functionality
-- This script creates the tables required for AI sub-task planning features

-- Create assignment_plans table
CREATE TABLE IF NOT EXISTS public.assignment_plans (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  assignment_id BIGINT NOT NULL REFERENCES public.assignments(id) ON DELETE CASCADE,
  original_instructions TEXT NOT NULL,
  sub_tasks JSONB DEFAULT '[]'::jsonb,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Create sub_tasks table  
CREATE TABLE IF NOT EXISTS public.sub_tasks (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  plan_id BIGINT NOT NULL REFERENCES public.assignment_plans(id) ON DELETE CASCADE,
  step_number INTEGER NOT NULL,
  title TEXT NOT NULL,
  generated_prompt TEXT NOT NULL,
  description TEXT,
  estimated_hours DECIMAL(5,2) DEFAULT 1.0,
  status TEXT NOT NULL DEFAULT 'pending' CHECK (status IN ('pending', 'in_progress', 'completed')),
  due_date TIMESTAMPTZ,
  order_index INTEGER NOT NULL DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Create refinement_messages table (if not already exists)
CREATE TABLE IF NOT EXISTS public.refinement_messages (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  plan_id BIGINT NOT NULL REFERENCES public.assignment_plans(id) ON DELETE CASCADE,
  message_type TEXT NOT NULL CHECK (message_type IN ('user', 'system')),
  content TEXT NOT NULL,
  timestamp TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  change_summary TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Add indexes for performance
CREATE INDEX IF NOT EXISTS idx_assignment_plans_assignment_id ON public.assignment_plans(assignment_id);
CREATE INDEX IF NOT EXISTS idx_sub_tasks_plan_id ON public.sub_tasks(plan_id);
CREATE INDEX IF NOT EXISTS idx_sub_tasks_order ON public.sub_tasks(plan_id, order_index);
CREATE INDEX IF NOT EXISTS idx_refinement_messages_plan_id ON public.refinement_messages(plan_id);
CREATE INDEX IF NOT EXISTS idx_refinement_messages_created_at ON public.refinement_messages(created_at);

-- Enable Row Level Security
ALTER TABLE public.assignment_plans ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.sub_tasks ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.refinement_messages ENABLE ROW LEVEL SECURITY;

-- RLS Policies for assignment_plans
CREATE POLICY "Users can access their own assignment plans" ON public.assignment_plans
  FOR ALL USING (
    EXISTS (
      SELECT 1 FROM public.assignments a
      WHERE a.id = assignment_plans.assignment_id 
      AND a.user_id = auth.uid()
    )
  );

CREATE POLICY "Users can insert assignment plans for their assignments" ON public.assignment_plans
  FOR INSERT WITH CHECK (
    EXISTS (
      SELECT 1 FROM public.assignments a
      WHERE a.id = assignment_id 
      AND a.user_id = auth.uid()
    )
  );

-- RLS Policies for sub_tasks
CREATE POLICY "Users can access sub_tasks for their own plans" ON public.sub_tasks
  FOR ALL USING (
    EXISTS (
      SELECT 1 FROM public.assignment_plans ap
      JOIN public.assignments a ON ap.assignment_id = a.id
      WHERE ap.id = sub_tasks.plan_id 
      AND a.user_id = auth.uid()
    )
  );

CREATE POLICY "Users can insert sub_tasks for their own plans" ON public.sub_tasks
  FOR INSERT WITH CHECK (
    EXISTS (
      SELECT 1 FROM public.assignment_plans ap
      JOIN public.assignments a ON ap.assignment_id = a.id
      WHERE ap.id = plan_id 
      AND a.user_id = auth.uid()
    )
  );

-- RLS Policies for refinement_messages
CREATE POLICY "Users can access refinement messages for their own plans" ON public.refinement_messages
  FOR ALL USING (
    EXISTS (
      SELECT 1 FROM public.assignment_plans ap
      JOIN public.assignments a ON ap.assignment_id = a.id
      WHERE ap.id = refinement_messages.plan_id 
      AND a.user_id = auth.uid()
    )
  );

CREATE POLICY "Users can insert refinement messages for their own plans" ON public.refinement_messages
  FOR INSERT WITH CHECK (
    EXISTS (
      SELECT 1 FROM public.assignment_plans ap
      JOIN public.assignments a ON ap.assignment_id = a.id
      WHERE ap.id = plan_id 
      AND a.user_id = auth.uid()
    )
  );

-- Grant necessary permissions
GRANT ALL ON public.assignment_plans TO authenticated;
GRANT ALL ON public.sub_tasks TO authenticated;
GRANT ALL ON public.refinement_messages TO authenticated;
GRANT USAGE ON SEQUENCE public.assignment_plans_id_seq TO authenticated;
GRANT USAGE ON SEQUENCE public.sub_tasks_id_seq TO authenticated;
GRANT USAGE ON SEQUENCE public.refinement_messages_id_seq TO authenticated;
```

## Step 3: Verify Installation

After running the SQL, you can verify the tables were created by checking the "Database" section in your Supabase dashboard. You should see:
- `assignment_plans`
- `sub_tasks` 
- `refinement_messages`

## Step 4: Test the Planning Feature

Once the tables are created, the assignment planning feature should work correctly:

1. Go to any assignment in your app
2. Upload assignment instructions 
3. Click "Begin Planning"
4. The AI should generate sub-tasks and display them

## Troubleshooting

If you encounter any errors:
1. Make sure all the SQL commands executed successfully
2. Check that the tables exist in your database
3. Verify that the RLS policies are active
4. Try refreshing your application

If you continue to have issues, the error messages in the browser console will provide more specific information about what's failing.