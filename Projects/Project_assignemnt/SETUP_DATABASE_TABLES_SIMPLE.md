# Simple Database Setup for Assignment Planning

Since some policies already exist, run this simplified version:

## Step 1: Create Tables Only

Run this in your Supabase SQL Editor:

```sql
-- Create missing tables for assignment planning functionality

-- Create assignment_plans table
CREATE TABLE IF NOT EXISTS public.assignment_plans (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  assignment_id BIGINT NOT NULL REFERENCES public.assignments(id) ON DELETE CASCADE,
  original_instructions TEXT NOT NULL,
  sub_tasks JSONB DEFAULT '[]'::jsonb,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Create sub_tasks table  
CREATE TABLE IF NOT EXISTS public.sub_tasks (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  plan_id BIGINT NOT NULL REFERENCES public.assignment_plans(id) ON DELETE CASCADE,
  step_number INTEGER NOT NULL,
  title TEXT NOT NULL,
  generated_prompt TEXT NOT NULL,
  description TEXT,
  estimated_hours DECIMAL(5,2) DEFAULT 1.0,
  status TEXT NOT NULL DEFAULT 'pending' CHECK (status IN ('pending', 'in_progress', 'completed')),
  due_date TIMESTAMPTZ,
  order_index INTEGER NOT NULL DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Create refinement_messages table (if not already exists)
CREATE TABLE IF NOT EXISTS public.refinement_messages (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  plan_id BIGINT NOT NULL REFERENCES public.assignment_plans(id) ON DELETE CASCADE,
  message_type TEXT NOT NULL CHECK (message_type IN ('user', 'system')),
  content TEXT NOT NULL,
  timestamp TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  change_summary TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Add indexes for performance
CREATE INDEX IF NOT EXISTS idx_assignment_plans_assignment_id ON public.assignment_plans(assignment_id);
CREATE INDEX IF NOT EXISTS idx_sub_tasks_plan_id ON public.sub_tasks(plan_id);
CREATE INDEX IF NOT EXISTS idx_sub_tasks_order ON public.sub_tasks(plan_id, order_index);
CREATE INDEX IF NOT EXISTS idx_refinement_messages_plan_id ON public.refinement_messages(plan_id);
CREATE INDEX IF NOT EXISTS idx_refinement_messages_created_at ON public.refinement_messages(created_at);

-- Enable Row Level Security
ALTER TABLE public.assignment_plans ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.sub_tasks ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.refinement_messages ENABLE ROW LEVEL SECURITY;

-- Grant necessary permissions
GRANT ALL ON public.assignment_plans TO authenticated;
GRANT ALL ON public.sub_tasks TO authenticated;
GRANT ALL ON public.refinement_messages TO authenticated;
GRANT USAGE ON SEQUENCE public.assignment_plans_id_seq TO authenticated;
GRANT USAGE ON SEQUENCE public.sub_tasks_id_seq TO authenticated;
GRANT USAGE ON SEQUENCE public.refinement_messages_id_seq TO authenticated;
```

## Step 2: Add Missing Policies (Only if Needed)

If you get permission errors after testing, run these policies one by one:

```sql
-- Only run these if you get permission errors

-- Policies for assignment_plans (skip if they already exist)
CREATE POLICY "Users can access their own assignment plans" ON public.assignment_plans
  FOR ALL USING (
    EXISTS (
      SELECT 1 FROM public.assignments a
      WHERE a.id = assignment_plans.assignment_id 
      AND a.user_id = auth.uid()
    )
  );

CREATE POLICY "Users can insert assignment plans for their assignments" ON public.assignment_plans
  FOR INSERT WITH CHECK (
    EXISTS (
      SELECT 1 FROM public.assignments a
      WHERE a.id = assignment_id 
      AND a.user_id = auth.uid()
    )
  );

-- Policies for sub_tasks (skip if they already exist)
CREATE POLICY "Users can access sub_tasks for their own plans" ON public.sub_tasks
  FOR ALL USING (
    EXISTS (
      SELECT 1 FROM public.assignment_plans ap
      JOIN public.assignments a ON ap.assignment_id = a.id
      WHERE ap.id = sub_tasks.plan_id 
      AND a.user_id = auth.uid()
    )
  );

CREATE POLICY "Users can insert sub_tasks for their own plans" ON public.sub_tasks
  FOR INSERT WITH CHECK (
    EXISTS (
      SELECT 1 FROM public.assignment_plans ap
      JOIN public.assignments a ON ap.assignment_id = a.id
      WHERE ap.id = plan_id 
      AND a.user_id = auth.uid()
    )
  );

-- Policies for refinement_messages (skip if they already exist)  
CREATE POLICY "Users can access refinement messages for their own plans" ON public.refinement_messages
  FOR ALL USING (
    EXISTS (
      SELECT 1 FROM public.assignment_plans ap
      JOIN public.assignments a ON ap.assignment_id = a.id
      WHERE ap.id = refinement_messages.plan_id 
      AND a.user_id = auth.uid()
    )
  );

CREATE POLICY "Users can insert refinement messages for their own plans" ON public.refinement_messages
  FOR INSERT WITH CHECK (
    EXISTS (
      SELECT 1 FROM public.assignment_plans ap
      JOIN public.assignments a ON ap.assignment_id = a.id
      WHERE ap.id = plan_id 
      AND a.user_id = auth.uid()
    )
  );
```

## Step 3: Test

After running the first script, try the assignment planning feature. If you get permission errors, then run individual policies from Step 2 as needed.